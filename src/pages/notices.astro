---
import '../styles/global.css';
import Layout from '../components/Layout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import { getCollection } from 'astro:content';
import { getTranslations } from '../content/translations';
import { marked } from 'marked';

const t = getTranslations('en');
const lang = 'en';

// Get all notices sorted by date (most recent first)
const allNotices = await getCollection('notices');
const noticesRaw = allNotices
	.map(n => n.data)
	.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Parse markdown content for all notices
const notices = await Promise.all(
	noticesRaw.map(async (notice) => ({
		...notice,
		contentHtml: await marked.parse(notice.content[lang])
	}))
);

// Format date for display
const formatDate = (dateStr: string) => {
	const date = new Date(dateStr);
	return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
};

// Auto-filled signature
const signature = 'Dongmyung Shin, CEO, OmixAI Inc.';

const pageTitle = 'Company Notices';
const pageSubtitle = 'Official announcements and regulatory notices';
---

<Layout lang="en" title={`${pageTitle} - ${t.meta.title}`} description="Official notices and announcements from OmixAI Inc." currentPage="resources" lightHeader={false}>
	<!-- Hero Section -->
	<section class="bg-section-alt py-16">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<Breadcrumb lang={lang} items={[
				{ name: t.nav.resources, url: '/resources' },
				{ name: pageTitle, url: '/notices' }
			]} />
			<div class="text-center">
				<h1 class="text-3xl md:text-4xl text-heading mb-3 animate-fade-in-up">
					{pageTitle}
				</h1>
				<p class="text-lg text-body animate-fade-in-up">
					{pageSubtitle}
				</p>
			</div>
		</div>
	</section>

	<!-- Notices List -->
	<section class="bg-section py-12">
		<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="space-y-8">
				{notices.map((notice) => (
					<article class="glass-card rounded-2xl overflow-hidden">
						<!-- Notice Header -->
						<div class="bg-[var(--brand-teal)]/10 border-b border-subtle px-6 py-4">
							<div class="flex flex-wrap items-center justify-between gap-2">
								<h2 class="text-xl font-semibold text-heading">{notice.title[lang]}</h2>
								<div class="flex items-center gap-3">
									{notice.active && (
										<span class="px-3 py-1 text-xs font-medium bg-[var(--brand-teal)] text-white rounded-full">
											Current
										</span>
									)}
									<time class="text-sm text-muted">{formatDate(notice.date)}</time>
								</div>
							</div>
						</div>

						<!-- Notice Content -->
						<div class="px-6 py-5 text-body text-sm leading-relaxed">
							<div class="prose prose-sm prose-invert max-w-none mb-5" set:html={notice.contentHtml} />

							<div class="pt-4 border-t border-subtle text-muted text-xs">
								<p>{signature}</p>
							</div>
						</div>
					</article>
				))}
			</div>

			{notices.length === 0 && (
				<div class="text-center py-16">
					<p class="text-muted text-lg">No notices available at this time.</p>
				</div>
			)}
		</div>
	</section>
</Layout>
