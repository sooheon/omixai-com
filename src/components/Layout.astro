---
import Header from './Header.astro';
import Footer from './Footer.astro';
import AnnouncementBanner from './AnnouncementBanner.astro';

interface Props {
	lang: 'en' | 'ko';
	title: string;
	description?: string;
	currentPage?: 'home' | 'services' | 'resources' | 'about' | 'contact';
	serviceSlug?: string;
	lightHeader?: boolean;
	ogImage?: string;
}

const { lang, title, currentPage, serviceSlug, lightHeader = false, ogImage = '/og-image.png' } = Astro.props;

// Default descriptions
const defaultDescriptions = {
	en: 'OmixAI provides AI-powered multi-omics analysis services for cell culture, tissue, and blood samples. Fast, accurate proteomics and metabolomics for researchers.',
	ko: 'OmixAI는 세포 배양, 조직, 혈액 샘플을 위한 AI 기반 멀티오믹스 분석 서비스를 제공합니다. 연구자를 위한 빠르고 정확한 프로테오믹스 및 대사체학 분석.'
};
const description = Astro.props.description || defaultDescriptions[lang];

// Canonical and alternate URLs
const currentPath = Astro.url.pathname;
const baseUrl = 'https://www.omixai.com';

// Normalize path for canonical
const canonicalPath = currentPath.endsWith('/') && currentPath !== '/'
	? currentPath.slice(0, -1)
	: currentPath;
const canonicalUrl = `${baseUrl}${canonicalPath}`;

// Generate hreflang URLs
const enPath = lang === 'en' ? currentPath : (currentPath === '/ko' || currentPath === '/ko/' ? '/' : currentPath.replace(/^\/ko/, ''));
const koPath = lang === 'ko' ? currentPath : (currentPath === '/' ? '/ko' : `/ko${currentPath}`);
const enUrl = `${baseUrl}${enPath}`;
const koUrl = `${baseUrl}${koPath}`;

// Only index production site
const isProduction = Astro.url.hostname === 'www.omixai.com' || Astro.url.hostname === 'omixai.com';
---

<html lang={lang}>
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/png" href="/favicon.png" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />

		<!-- SEO Meta Tags -->
		<title>{title}</title>
		<meta name="description" content={description} />
		{!isProduction && <meta name="robots" content="noindex, nofollow" />}
		<link rel="canonical" href={canonicalUrl} />

		<!-- Hreflang for language alternates -->
		<link rel="alternate" hreflang="en" href={enUrl} />
		<link rel="alternate" hreflang="ko" href={koUrl} />
		<link rel="alternate" hreflang="x-default" href={enUrl} />

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:url" content={canonicalUrl} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={`${baseUrl}${ogImage}`} />
		<meta property="og:locale" content={lang === 'ko' ? 'ko_KR' : 'en_US'} />
		<meta property="og:site_name" content="OmixAI" />

		<!-- Twitter Card -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:url" content={canonicalUrl} />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={`${baseUrl}${ogImage}`} />

		<!-- Search Engine Verification -->
		<meta name="google-site-verification" content="kN6uY4QFgi3IE87l3l8ZenJ1zduAASO2GVdfaGbjRmA" />
		<meta name="naver-site-verification" content="9737a4d3c43d0ca09fcc72e421b92323e78c92c6" />

		<!-- Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet" />
		<link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

		<!-- JSON-LD Structured Data -->
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "Organization",
			"name": "OmixAI",
			"url": "https://www.omixai.com",
			"logo": "https://www.omixai.com/bwlogo.png",
			"description": defaultDescriptions.en,
			"address": {
				"@type": "PostalAddress",
				"streetAddress": "43 Janghan-ro",
				"addressLocality": "Dongdaemun-gu",
				"addressRegion": "Seoul",
				"addressCountry": "KR"
			},
			"sameAs": []
		})} />
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "WebSite",
			"name": "OmixAI",
			"url": "https://www.omixai.com",
			"inLanguage": ["en", "ko"]
		})} />

		<!-- Prevent flash: set theme before render -->
		<script is:inline>
			(function() {
				const saved = localStorage.getItem('theme');
				const theme = saved || 'dark'; // Default to dark mode
				document.documentElement.setAttribute('data-theme', theme);
			})();
		</script>
		<style is:inline>
			html, body {
				background-color: var(--bg-page, #0f172a);
			}
			body {
				font-family: 'Inter', 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
				line-height: 1.6;
				font-weight: 400;
				display: flex;
				flex-direction: column;
				min-height: 100vh;
				color: var(--text-body, #e2e8f0);
			}
			h1, h2, h3, h4, h5, h6 {
				font-family: 'Space Grotesk', 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
				letter-spacing: -0.02em;
				line-height: 1.2;
				color: var(--text-heading, #f1f5f9);
			}
			p {
				line-height: 1.7;
			}
			a[class*="px-"], button[class*="px-"] {
				letter-spacing: -0.01em;
			}
			main {
				flex: 1;
				display: flex;
				flex-direction: column;
				padding-top: 80px;
			}
		</style>
	</head>
	<body>
		<AnnouncementBanner lang={lang} />
		<Header lang={lang} currentPage={currentPage} serviceSlug={serviceSlug} lightHeader={lightHeader} />
		<main>
			<slot />
		</main>
		<Footer lang={lang} />
	</body>
</html>
