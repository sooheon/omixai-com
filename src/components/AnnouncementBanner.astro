---
import { getCollection } from 'astro:content';
import { marked } from 'marked';

interface Props {
	lang: 'en' | 'ko';
}

const { lang } = Astro.props;

// Get all notices sorted by date (most recent first)
const allNotices = await getCollection('notices');
const sortedNotices = allNotices
	.map(n => n.data)
	.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Show most recent active notice, or fall back to most recent notice if none active
// If multiple notices are active, the most recent one by date takes priority
const activeNotice = sortedNotices.find(n => n.active) || sortedNotices[0];

// Parse markdown content
const contentHtml = activeNotice ? await marked.parse(activeNotice.content[lang]) : '';

// Format date for display
const formatDate = (dateStr: string, lang: 'en' | 'ko') => {
	const date = new Date(dateStr);
	if (lang === 'ko') {
		return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
	}
	return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
};

// Auto-filled signature
const signature = {
	ko: '주식회사 오믹스에이아이 대표이사 신동명',
	en: 'Dongmyung Shin, CEO, OmixAI Inc.'
};

// UI strings
const confirmText = lang === 'en' ? 'OK' : '확인';
const noticesUrl = lang === 'en' ? '/notices' : '/ko/notices';
const viewAllText = lang === 'en' ? 'View all notices' : '모든 공고 보기';
---

{activeNotice && (
	<>
		<!-- Banner -->
		<button id="announcement-banner" class="fixed top-0 left-0 right-0 z-[60] bg-[#1e3a4c] text-white/90 text-sm cursor-pointer hover:bg-[#254555] transition-colors w-full text-left px-4 pt-2 pb-2.5 block">
			<div class="max-w-7xl mx-auto">
				<div class="flex items-center gap-2">
					<svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
					</svg>
					<span class="font-medium">{activeNotice.title[lang]}</span>
					<span class="text-white/70 text-xs hidden sm:inline">- {lang === 'en' ? 'Click for details' : '클릭하여 자세히 보기'}</span>
				</div>
			</div>
		</button>

		<!-- Modal -->
		<div id="announcement-modal" class="fixed inset-0 z-[100] hidden">
			<div id="modal-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
			<div id="modal-wrapper" class="absolute inset-0 flex items-center justify-center p-4">
				<div id="modal-content" class="relative bg-[var(--bg-card)] border border-subtle rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
					<!-- Header -->
					<div class="sticky top-0 bg-[var(--brand-teal)] text-white px-6 py-4 rounded-t-2xl">
						<div class="flex items-center justify-between">
							<div class="flex items-center gap-3">
								<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
								</svg>
								<h2 class="text-xl font-semibold">{activeNotice.title[lang]}</h2>
							</div>
							<button id="modal-close" class="p-1.5 hover:bg-white/20 rounded-lg transition-colors" aria-label="Close">
								<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
								</svg>
							</button>
						</div>
					</div>

					<!-- Content -->
					<div class="px-6 py-5 text-body text-sm leading-relaxed">
						<div class="prose prose-sm prose-invert mb-5" set:html={contentHtml} />

						<div class="pt-4 border-t border-subtle text-muted text-xs">
							<p>{formatDate(activeNotice.date, lang)}</p>
							<p>{signature[lang]}</p>
						</div>
					</div>

					<!-- Footer -->
					<div class="px-6 py-4 border-t border-subtle bg-[var(--bg-section-alt)] rounded-b-2xl">
						<div class="flex gap-3">
							<a href={noticesUrl} class="flex-1 py-3 rounded-full font-medium border border-subtle text-body hover:bg-[var(--bg-section)] transition-colors text-center">
								{viewAllText}
							</a>
							<button id="modal-confirm" class="flex-1 py-3 rounded-full font-medium bg-[var(--bg-card)] border border-subtle text-body hover:bg-[var(--bg-section)] transition-colors">
								{confirmText}
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<style>
			#modal-content {
				animation: modal-in 0.2s ease-out;
			}
			@keyframes modal-in {
				from {
					opacity: 0;
					transform: translateY(10px) scale(0.98);
				}
				to {
					opacity: 1;
					transform: translateY(0) scale(1);
				}
			}
		</style>

		<script>
			const banner = document.getElementById('announcement-banner');
			const modal = document.getElementById('announcement-modal');
			const modalWrapper = document.getElementById('modal-wrapper');
			const modalClose = document.getElementById('modal-close');
			const modalConfirm = document.getElementById('modal-confirm');
			const header = document.getElementById('header');
			const main = document.querySelector('main');

			function updateLayoutForBanner() {
				if (!banner || !header) return;
				const bannerHeight = banner.offsetHeight;
				const headerHeight = 80; // Base header height
				header.style.top = bannerHeight + 'px';
				if (main) {
					main.style.paddingTop = (bannerHeight + headerHeight) + 'px';
				}
			}

			function openModal() {
				if (modal) {
					modal.classList.remove('hidden');
					document.body.style.overflow = 'hidden';
				}
			}

			function closeModal() {
				if (modal) {
					modal.classList.add('hidden');
					document.body.style.overflow = '';
				}
			}

			// Update layout after render and fonts load
			requestAnimationFrame(() => {
				updateLayoutForBanner();
				setTimeout(updateLayoutForBanner, 100);
			});
			document.fonts?.ready.then(updateLayoutForBanner);

			// Event listeners
			banner?.addEventListener('click', openModal);
			modalClose?.addEventListener('click', closeModal);
			modalConfirm?.addEventListener('click', closeModal);
			modalWrapper?.addEventListener('click', closeModal);

			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
					closeModal();
				}
			});

			window.addEventListener('resize', updateLayoutForBanner);
		</script>
	</>
)}
